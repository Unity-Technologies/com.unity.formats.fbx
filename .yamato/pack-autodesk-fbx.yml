# This yml file contains jobs for packing com.autodesk.fbx package which is a submodule of com.unity.formats.fbx

{% metadata_file .yamato/global.metafile %}
---

build_win:
  name: Build on win
  agent:
    type: Unity::VM::GPU
    image: {{ win_platform.image }}
    flavor: {{ win_platform.flavor}}
  commands:
    # Load submodule and update it
    - git submodule update --init --recursive
    - git submodule update --remote
    - choco -v -y install 7zip
    - python External\com.autodesk.fbx\build.py --stevedore --verbose --clean --yamato
    - |
      cd External\com.autodesk.fbx
      ren build build-win
  artifacts:
    build:
      paths:
        - "External/com.autodesk.fbx/build-win/install/**"

build_mac:
  name: Build on mac
  agent:
    type: {{ mac_platform.type }}
    image: {{ mac_platform.image }}
    flavor: {{ mac_platform.flavor}}
  variables:
    HOMEBREW_NO_INSTALL_CLEANUP: "1"
  commands:
    # Load submodule and update it
    - git submodule update --init --recursive
    - git submodule update --remote
    # We need to install p7zip.
    - brew list p7zip || brew install p7zip
    - cmake --version || brew install cmake
    - python ./External/com.autodesk.fbx/build.py --stevedore --verbose --clean --yamato
    - mv ./External/com.autodesk.fbx/build ./External/com.autodesk.fbx/build-mac
  artifacts:
    build:
      paths:
        - "External/com.autodesk.fbx/build-mac/install/**"

build_ubuntu:
  name: Build on ubuntu
  agent:
    type: {{ ubuntu_platform.type }}
    image: {{ ubuntu_platform.image }}
    flavor: {{ ubuntu_platform.flavor}}
  commands:
    # Load submodule and update it
    - git submodule update --init --recursive
    - git submodule update --remote
    # FBX SDK 2020.2 requires gcc 9.3
    - sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
    - sudo apt-get update
    - sudo apt-get -y install cmake
    - sudo apt-get -y install libxml2-dev
    - sudo apt-get -y install gcc-9 g++-9
    - sudo apt-get install p7zip mono-devel
    # Ensure correct version of gcc and g++ used
    # https://stackoverflow.com/questions/17275348/how-to-specify-new-gcc-path-for-cmake
    - CC=`which gcc-9` CXX=`which g++-9` python ./External/com.autodesk.fbx/build.py --stevedore --verbose --clean --yamato
    - mv ./External/com.autodesk.fbx/build ./External/com.autodesk.fbx/build-ubuntu
  artifacts:
    build:
      paths:
        - "External/com.autodesk.fbx/build-ubuntu/install/**"

pack_autodesk_fbx:
  name: Pack com.autodesk.fbx package 
  agent:
    type: {{ ubuntu_platform.type }}
    image: {{ ubuntu_platform.image }}
    flavor: {{ ubuntu_platform.flavor}}
  commands:
    - cp -vrfp ./External/com.autodesk.fbx/build-ubuntu/install/* ./External/com.autodesk.fbx
    - cp -vrfp ./External/com.autodesk.fbx/build-mac/install/* ./External/com.autodesk.fbx
    - cp -vrfp ./External/com.autodesk.fbx/build-win/install/* ./External/com.autodesk.fbx
    - npm install -g upm-ci-utils@stable --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm
    - upm-ci package pack --package-path External/com.autodesk.fbx/com.autodesk.fbx
  dependencies:
    - .yamato/pack-autodesk-fbx.yml#build_win
    - .yamato/pack-autodesk-fbx.yml#build_mac
    - .yamato/pack-autodesk-fbx.yml#build_ubuntu
  artifacts:
    build:
      paths:
        - "External/com.autodesk.fbx/build-ubuntu/install/**"
        - "External/com.autodesk.fbx/build-mac/install/**"
        - "External/com.autodesk.fbx/build-win/install/**"
    packages:
      paths:
        - "upm-ci~/packages/**"
    build_output:
      paths:
        - "External/com.autodesk.fbx/com.autodesk.fbx/**"
